name: Run BB Touch Bot

on:
  schedule:
    - cron: '1 */4 * * *'  # Every 4 Hour
  workflow_dispatch:  # Manual trigger

jobs:
  run-bot:
    runs-on: ubuntu-latest
    
    # Use micromamba-shell for all steps (auto-activates environment)
    defaults:
      run:
        shell: micromamba-shell {0}

    env:
      REDIS_URL: ${{ secrets.REDIS_URL }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Micromamba
        uses: mamba-org/setup-micromamba@v2
        with:
          environment-file: environment.yml
          environment-name: bb-touch-bot
          cache-environment: true    # Cache the installed environment
          cache-downloads: true      # Cache package downloads
          post-cleanup: 'all'        # Clean up after run to save space
          init-shell: >-
            bash
            powershell

      - name: Verify environment
        run: |
          python --version
          python -c "import talib; import numpy; import aiohttp; print('âœ… All imports OK')"

      - name: Run bot
        run: python RsiBot.py
